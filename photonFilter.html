<!DOCTYPE html>
<html>
 <!-- Simulation of photons being filtered -->
 <!-- Created by Tristan Miller, May 2016 -->
 <!-- Download and then open in your browser. A bit slow in Firefox though! -->  
<head>
<meta charset="utf-8">
<title>Photon Filtering</title>
<style>
canvas {
    border: 3px #CCC solid;
}

#ui {
	width: 30%;
	position: absolute;
	top: 75%;
}

input.comptrol {
position:relative;
left:30%;
}

#screen {
position: absolute;
top:10%;
height:60%;
}


label {
	position:absolute;
	width:30%;
}
</style>
</head>

<body>

<h1 id="theTitle">Photon detection</h1>



<div id="graphics">
    <canvas id="screen" height="600" width="600"></canvas>
</div>

<div id = "ui">
	<label for="brightnessS" >Brightness</label>
	<input type="range" class="comptrol" id="brightnessS"  min="0" max ="50" step="1" value="250" onInput="inputUpdate(value, min, max, id, 'brightnessT')" >
	<input type="text" class="comptrol"id="brightnessT" min="0" max="50"  value="250" onInput="inputUpdate(value, min, max, id, 'brightnessS')">
	<br>
	<label for="colourS" >Colour</label>
	<input type="range" id="colourS" class="comptrol" min = "0" max = "260" step = "0.1" value="120" onInput="inputUpdate(value, min,max, id, 'colourT')">
	<input type="text" id="colourT" class="comptrol" min = "0" max = "260" value = "120" onInput="inputUpdate(value, min,max, id, 'colourS')">
	<br>	
	<label for="fadeS" >Fade rate</label>
	<input type="range" id="fadeS" class="comptrol" min = "0" max = "100" step = "0.1" value="10" onInput="inputUpdate(value, min, max,id, 'fadeT')">
	<input type="text" id="fadeT" class="comptrol" min = "0" max = "100" value = "10" onInput="inputUpdate(value, min, max, id, 'fadeS')">
	<br>	
	<button type="button" id="playPause" onclick="buttonChange()">Pause</button>
	<button type="button" id="reset" onClick="resetScreen()">Reset</button>
	
</div>

<script>

var pause = false;
	
	var mouseX = 0;
	var mouseY = 0;
	
	var title = document.querySelector("#theTitle");
	document.querySelector("#screen").width = document.querySelector("#screen").height;
	var mainCanvas = document.querySelector("#screen");
	var mainContext = mainCanvas.getContext("2d");

	mainCanvas.addEventListener('mousemove', function(event){
			mouseX = event.pageX - mainCanvas.offsetLeft;
			mouseY = event.pageY - mainCanvas.offsetTop;
	});
	
	var canvasWidth = mainCanvas.width;
	var canvasHeight = mainCanvas.height;
	


	var requestAnimationFrame = window.requestAnimationFrame || 
                            window.mozRequestAnimationFrame || 
                            window.webkitRequestAnimationFrame || 
                            window.msRequestAnimationFrame;
							
							

	var photons = new Array();
	var photonVel = 7; //pixels per frame. This is the speed of light!

	var minVisEn = 1.8; //eV
	var maxVisEn = 3.1; //eV
	
	var trailLength = 5;

resetScreen();
drawPhotons();

function drawPhotons() {
	

	var brightness = getInputValue("brightnessS");
	var lampColour = "hsla(" + getInputValue("colourS") + ", 100%, " +50+ "%, 0.95)";
	var fadeRate = getInputValue("fadeS");
	
  	mainContext.fillStyle = "rgba(0,0,0," + fadeRate/100 + ")";
  	mainContext.fillRect(0, 0, canvasWidth, canvasHeight);	
	
	updatePhotons(photons);

	
	removePhotons(photons);

	if(brightness > 0){
 	   for (var i = 0; i < brightness; i++) {
if(Math.random()>0.8){
			   createPhoton(photons);
			   }
		   
	   }
   }
   

   
   if(!pause){
	   requestAnimationFrame(drawPhotons);
   }
}



function constrain (val, min, max) {
	return(Math.min(Math.max(val, min), max));
}

function map_range (val, oldLow, oldHigh, newLow, newHigh){
return(((oldLow + val)/(oldHigh - oldLow))*(newHigh - newLow) + newLow);

}

function inputUpdate(val, min, max, idThis, idThat) {
	val = constrain(val,min,max);
	document.querySelector("#"+idThis).value = val;
	document.querySelector("#"+idThat).value = val;
}
	
function getInputValue(id) {
    return(document.getElementById(id).value);
}

function buttonChange(){
	var button = document.querySelector('#playPause');
	if(pause){
		button.textContent="Pause";
		requestAnimationFrame(drawPhotons);
	} else {
		button.textContent="Play";	
	}
	pause = !pause;
}

function resetScreen(){
	mainContext.fillStyle = "rgba(0,0,0,1)";
	mainContext.fillRect(0, 0, canvasWidth, canvasHeight);
}

function createPhoton(p){
		var en = map_range(Math.random(),0,1,minVisEn,maxVisEn);
		var newPhoton = new Photon(map_range(Math.random(),0,1,0,photonVel), map_range(Math.random(),0,1,0.4*canvasHeight,0.6*canvasHeight), photonVel, 0, en);
		p.push(newPhoton);

}
function updatePhotons(p){
	for(var i = 0; i < p.length; i++) {
		var thisPhoton = p[i];
		thisPhoton.update();
		if(thisPhoton.posX > canvasWidth || thisPhoton.posX < 0 || thisPhoton.posY > canvasHeight || thisPhoton.posY < 0){
		thisPhoton.alive = false;
		}
		thisPhoton.render();	

	}
}

function removePhotons(p){
for(var i = p.length - 1; i >= 0; i--) {
		var thisPhoton = p[i];
		if(!thisPhoton.alive){
		p.splice(i,1);
		}	
	}
}
//Object definitions							
							
function Photon(posX, posY, velX, velY, energy) {
	
	this.radius = 2;
	this.posX = posX;
	this.posY = posY;
	this.velX = velX;
	this.velY = velY;
	this.energy = energy;
	this.alive = true;
	
	energy = constrain(energy, minVisEn, maxVisEn);
	this.col = Math.round(map_range(energy, minVisEn, maxVisEn, 0, 260));
	

	this.fillStyle = "hsla(" + this.col + ",100%,50%,1)";

	
	this.update = function(){
	
		this.posX = this.posX + this.velX;
		this.posY = this.posY + this.velY;	
		
	}
	
	this.render = function(){

		
		//mainContext.beginPath();
		//mainContext.arc(this.posX, this.posY, this.radius, 0, 2*Math.PI, false);
		//mainContext.closePath();
		mainContext.fillStyle = this.fillStyle;
		mainContext.fillRect(this.posX - this.radius, this.posY - this.radius, 2*this.radius, 2*this.radius);
		
		mainContext.fillStyle = "rgba(255,255,255,0.9)"
		mainContext.fillRect(this.posX - this.radius, this.posY - this.radius, 0.4*this.radius, 0.4*this.radius);
		
	}

}


</script>
</body>
</html>
